<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Шахматка объектов</title>
  <style>
    body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f7f8fa;color:#111827}
    .wrap{padding:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px}
    .cell{padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-weight:600;cursor:pointer;text-align:center}
  </style>
  <script src="https://api.bitrix24.com/api/v1/"></script>
</head>
<body>
<div class="wrap">
  <h2>Шахматка объектов</h2>
  <div id="board">Загрузка…</div>
</div>

<script>
  // === НАСТРОЙКИ ===
  const ENTITY_TYPE_ID = 176; // замените на ID вашего СПА
  const F = {
    UNIT: 'ufCrmUnit',     // поле с номером лота
    STATUS: 'ufCrmStatus'  // поле со статусом
  };

  const STATUS_COLOR = {
    free: '#36b37e',   // Свободно
    hold: '#f5c542',   // Бронь
    sold: '#a0aec0',   // Продано
    coming: '#60a5fa'  // Скоро
  };

  BX24.init(async () => {
    const select = ['id','title',F.UNIT,F.STATUS];
    const items = await loadAll(ENTITY_TYPE_ID, select);
    const board = document.getElementById('board');
    board.innerHTML = '';

    const grid = document.createElement('div');
    grid.className = 'grid';
    items.forEach(i => {
      const unit = i[F.UNIT] || '—';
      const status = i[F.STATUS] || 'free';
      const color = STATUS_COLOR[status] || '#d1d5db';
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.style.background = color;
      cell.textContent = unit;
      cell.title = Статус: ${status};
      cell.onclick = () => BX24.openPath(/crm/type/${ENTITY_TYPE_ID}/details/${i.id}/);
      grid.appendChild(cell);
    });
    board.appendChild(grid);
  });

  async function loadAll(entityTypeId, select){
    let start = 0, out = [];
    do{
      const data = await api('crm.item.list', { entityTypeId, select, start, order:{id:'asc'} });
      const part = data.items || data || [];
      out = out.concat(part);
      start = data.next || 0;
    } while (start > 0);
    return out;
  }
  function api(method, params){
    return new Promise((resolve, reject)=>{
      BX24.callMethod(method, params, res => res.error() ? reject(res.error()) : resolve(res.data()));
    });
  }
</script>
</body>
</html>
